services:
  # Serviço principal do Appwrite
  appwrite:
    image: 'appwrite/appwrite:1.7.4'
    ports:
      - '127.0.0.1:8989:80'
    container_name: appwrite
    networks:
      - appwrite-network
    volumes:
      - 'appwrite-uploads:/storage/uploads:rw'
      - 'appwrite-imports:/storage/imports:rw'
      - 'appwrite-cache:/storage/cache:rw'
      - 'appwrite-config:/storage/config:rw'
      - 'appwrite-certificates:/storage/certificates:rw'
      - 'appwrite-functions:/storage/functions:rw'
      - 'appwrite-sites:/storage/sites:rw'
      - 'appwrite-builds:/storage/builds:rw'
    depends_on:
      - appwrite-mariadb
      - appwrite-redis
    environment:
      - '_APP_ENV=production'
      - '_APP_EDITION=self-hosted'
      - '_APP_WORKER_PER_CORE=6'
      - '_APP_LOCALE=en'
      - '_APP_CONSOLE_WHITELIST_ROOT=enabled'
      - '_APP_SYSTEM_EMAIL_NAME=Appwrite'
      - '_APP_SYSTEM_EMAIL_ADDRESS=team@appwrite.io'
      - '_APP_SYSTEM_TEAM_EMAIL=team@appwrite.io'
      - '_APP_EMAIL_SECURITY=certs@appwrite.io'
      - '_APP_OPTIONS_ABUSE=enabled'
      # IMPORTANTE: Desabilitar HTTPS interno (Nginx cuida disso)
      - '_APP_OPTIONS_ROUTER_PROTECTION=disabled'
      - '_APP_OPTIONS_FORCE_HTTPS=disabled'
      - '_APP_OPTIONS_ROUTER_FORCE_HTTPS=disabled'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - _APP_CONSOLE_DOMAIN=appwrite.systemprog.shop
      - _APP_DOMAIN=appwrite.systemprog.shop
      - '_APP_DOMAIN_TARGET_CNAME=localhost'
      - '_APP_DOMAIN_TARGET_AAAA=::1'
      - '_APP_DOMAIN_TARGET_A=127.0.0.1'
      - _APP_DOMAIN_FUNCTIONS=functions.appwrite.systemprog.shop
      - _APP_DOMAIN_SITES=sites.appwrite.systemprog.shop
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_USAGE_STATS=enabled'
      - '_APP_STORAGE_LIMIT=30000000'
      - '_APP_STORAGE_PREVIEW_LIMIT=20000000'
      - '_APP_STORAGE_ANTIVIRUS=disabled'
      - '_APP_STORAGE_DEVICE=local'
      - '_APP_COMPUTE_SIZE_LIMIT=30000000'
      - '_APP_FUNCTIONS_TIMEOUT=900'
      - '_APP_SITES_TIMEOUT=900'
      - '_APP_COMPUTE_BUILD_TIMEOUT=900'
      - '_APP_COMPUTE_CPUS=0'
      - '_APP_COMPUTE_MEMORY=0'
      - '_APP_FUNCTIONS_RUNTIMES=node-20.0,php-8.2,python-3.11,ruby-3.2'
      - _APP_EXECUTOR_SECRET=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_EXECUTOR_HOST=http://appwrite-executor/v1'
      - '_APP_MAINTENANCE_INTERVAL=86400'
      - '_APP_MAINTENANCE_RETENTION_EXECUTION=1209600'
      - '_APP_MAINTENANCE_RETENTION_CACHE=2592000'
      - '_APP_MAINTENANCE_RETENTION_ABUSE=86400'
      - '_APP_MAINTENANCE_RETENTION_AUDIT=1209600'
      - '_APP_MAINTENANCE_RETENTION_USAGE_HOURLY=8640000'
      - '_APP_MAINTENANCE_RETENTION_SCHEDULES=86400'
      - '_APP_GRAPHQL_MAX_BATCH_SIZE=10'
      - '_APP_GRAPHQL_MAX_COMPLEXITY=250'
      - '_APP_GRAPHQL_MAX_DEPTH=3'
    healthcheck:
      test:
        - CMD-SHELL
        - "curl -fs http://localhost:80/v1/health | grep -q '\"status\":\"pass\"' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  # Console do Appwrite (agora mapeado para porta local)
  appwrite-console:
    image: 'appwrite/console:6.1.28'
    container_name: appwrite-console
    ports:
      - '127.0.0.1:8990:80'  # IMPORTANTE: Expor apenas localmente
    networks:
      - appwrite-network
    environment:
      # Removido SERVICE_URL_APPWRITE - Nginx cuida do roteamento
    healthcheck:
      test:
        - CMD-SHELL
        - "curl -fsI http://localhost:80 | head -n 1 | grep -E '^HTTP/.* 3[0-9]{2}|2[0-9]{2} ' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  # Serviço de tempo real
  appwrite-realtime:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: realtime
    container_name: appwrite-realtime
    networks:
      - appwrite-network
    depends_on:
      - appwrite-mariadb
      - appwrite-redis
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - '_APP_OPTIONS_ABUSE=enabled'
      - '_APP_OPTIONS_ROUTER_PROTECTION=disabled'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_USAGE_STATS=enabled'
    healthcheck:
      test:
        - CMD-SHELL
        - 'curl -s localhost > /dev/null || exit 1'
      interval: 20s
      timeout: 5s
      retries: 3

  # Workers (mantidos como antes)
  appwrite-worker-audits:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-audits
    container_name: appwrite-worker-audits
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-audits' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-webhooks:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-webhooks
    container_name: appwrite-worker-webhooks
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_EMAIL_SECURITY=certs@appwrite.io'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-webhooks' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-deletes:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-deletes
    container_name: appwrite-worker-deletes
    networks:
      - appwrite-network
    volumes:
      - 'appwrite-uploads:/storage/uploads:rw'
      - 'appwrite-cache:/storage/cache:rw'
      - 'appwrite-functions:/storage/functions:rw'
      - 'appwrite-sites:/storage/sites:rw'
      - 'appwrite-builds:/storage/builds:rw'
      - 'appwrite-certificates:/storage/certificates:rw'
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_STORAGE_DEVICE=local'
      - _APP_EXECUTOR_SECRET=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_EXECUTOR_HOST=http://appwrite-executor/v1'
      - '_APP_MAINTENANCE_RETENTION_AUDIT=1209600'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-deletes' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-databases:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-databases
    container_name: appwrite-worker-databases
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-databases' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-builds:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-builds
    container_name: appwrite-worker-builds
    networks:
      - appwrite-network
    volumes:
      - 'appwrite-functions:/storage/functions:rw'
      - 'appwrite-sites:/storage/sites:rw'
      - 'appwrite-builds:/storage/builds:rw'
      - 'appwrite-uploads:/storage/uploads:rw'
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - _APP_EXECUTOR_SECRET=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_EXECUTOR_HOST=http://appwrite-executor/v1'
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_FUNCTIONS_TIMEOUT=900'
      - '_APP_SITES_TIMEOUT=900'
      - '_APP_COMPUTE_BUILD_TIMEOUT=900'
      - '_APP_COMPUTE_CPUS=0'
      - '_APP_COMPUTE_MEMORY=0'
      - '_APP_COMPUTE_SIZE_LIMIT=30000000'
      - '_APP_OPTIONS_FORCE_HTTPS=disabled'
      - _APP_DOMAIN=appwrite.systemprog.shop
      - '_APP_STORAGE_DEVICE=local'
      - _APP_DOMAIN_SITES=sites.appwrite.systemprog.shop
      - _APP_CONSOLE_DOMAIN=appwrite.systemprog.shop
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-builds' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-certificates:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-certificates
    container_name: appwrite-worker-certificates
    networks:
      - appwrite-network
    volumes:
      - 'appwrite-config:/storage/config:rw'
      - 'appwrite-certificates:/storage/certificates:rw'
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - _APP_DOMAIN=appwrite.systemprog.shop
      - _APP_DOMAIN_FUNCTIONS=functions.appwrite.systemprog.shop
      - '_APP_EMAIL_CERTIFICATES=enabled'
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-certificates' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-functions:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-functions
    container_name: appwrite-worker-functions
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
      - openruntimes-executor
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - _APP_DOMAIN=appwrite.systemprog.shop
      - '_APP_OPTIONS_FORCE_HTTPS=disabled'
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_FUNCTIONS_TIMEOUT=900'
      - '_APP_SITES_TIMEOUT=900'
      - '_APP_COMPUTE_BUILD_TIMEOUT=900'
      - '_APP_COMPUTE_CPUS=0'
      - '_APP_COMPUTE_MEMORY=0'
      - _APP_EXECUTOR_SECRET=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_EXECUTOR_HOST=http://appwrite-executor/v1'
      - '_APP_USAGE_STATS=enabled'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-functions' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-mails:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-mails
    container_name: appwrite-worker-mails
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_SYSTEM_EMAIL_NAME=Appwrite'
      - '_APP_SYSTEM_EMAIL_ADDRESS=team@appwrite.io'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - _APP_DOMAIN=appwrite.systemprog.shop
      - '_APP_OPTIONS_FORCE_HTTPS=disabled'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-mails' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-messaging:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-messaging
    container_name: appwrite-worker-messaging
    networks:
      - appwrite-network
    volumes:
      - 'appwrite-uploads:/storage/uploads:rw'
    depends_on:
      - appwrite-redis
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_STORAGE_DEVICE=local'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-messaging' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-migrations:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-migrations
    container_name: appwrite-worker-migrations
    networks:
      - appwrite-network
    volumes:
      - 'appwrite-imports:/storage/imports:rw'
    depends_on:
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - _APP_DOMAIN=appwrite.systemprog.shop
      - '_APP_EMAIL_SECURITY=certs@appwrite.io'
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}

  appwrite-task-maintenance:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: maintenance
    container_name: appwrite-task-maintenance
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_DOMAIN=appwrite.systemprog.shop
      - _APP_DOMAIN_FUNCTIONS=functions.appwrite.systemprog.shop
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_MAINTENANCE_INTERVAL=86400'
      - '_APP_MAINTENANCE_RETENTION_EXECUTION=1209600'
      - '_APP_MAINTENANCE_RETENTION_CACHE=2592000'
      - '_APP_MAINTENANCE_RETENTION_ABUSE=86400'
      - '_APP_MAINTENANCE_RETENTION_AUDIT=1209600'
      - '_APP_MAINTENANCE_RETENTION_USAGE_HOURLY=8640000'
      - '_APP_MAINTENANCE_RETENTION_SCHEDULES=86400'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[m]aintenance' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-task-stats-resources:
    image: 'appwrite/appwrite:1.7.4'
    container_name: appwrite-task-stats-resources
    entrypoint: stats-resources
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_USAGE_STATS=enabled'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[s]tats-resources' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-stats-resources:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-stats-resources
    container_name: appwrite-worker-stats-resources
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_USAGE_STATS=enabled'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-stats-resources' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-worker-stats-usage:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: worker-stats-usage
    container_name: appwrite-worker-stats-usage
    networks:
      - appwrite-network
    depends_on:
      - appwrite-redis
      - appwrite-mariadb
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_USAGE_STATS=enabled'
      - '_APP_USAGE_AGGREGATION_INTERVAL=30'
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[w]orker-stats-usage' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-task-scheduler-functions:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: schedule-functions
    container_name: appwrite-task-scheduler-functions
    networks:
      - appwrite-network
    depends_on:
      - appwrite-mariadb
      - appwrite-redis
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[s]chedule-functi' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-task-scheduler-executions:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: schedule-executions
    container_name: appwrite-task-scheduler-executions
    networks:
      - appwrite-network
    depends_on:
      - appwrite-mariadb
      - appwrite-redis
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[s]chedule-execut' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-task-scheduler-messages:
    image: 'appwrite/appwrite:1.7.4'
    entrypoint: schedule-messages
    container_name: appwrite-task-scheduler-messages
    networks:
      - appwrite-network
    depends_on:
      - appwrite-mariadb
      - appwrite-redis
    environment:
      - '_APP_ENV=production'
      - '_APP_WORKER_PER_CORE=6'
      - _APP_OPENSSL_KEY_V1=${SERVICE_PASSWORD_64_APPWRITE}
      - '_APP_REDIS_HOST=appwrite-redis'
      - '_APP_REDIS_PORT=6379'
      - '_APP_DB_HOST=appwrite-mariadb'
      - '_APP_DB_PORT=3306'
      - '_APP_DB_SCHEMA=appwrite'
      - _APP_DB_USER=${SERVICE_USER_MARIADB}
      - _APP_DB_PASS=${SERVICE_PASSWORD_MARIADB}
    healthcheck:
      test:
        - CMD-SHELL
        - "ps aux | grep -q '[s]chedule-messag' || exit 1"
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-assistant:
    image: 'appwrite/assistant:0.8.3'
    container_name: appwrite-assistant
    networks:
      - appwrite-network
    healthcheck:
      test:
        - CMD-SHELL
        - 'wget --spider -q http://127.0.0.1:3003 || exit 0'
      interval: 20s
      timeout: 5s
      retries: 3

  appwrite-browser:
    image: 'appwrite/browser:0.2.4'
    container_name: appwrite-browser
    hostname: appwrite-browser
    networks:
      - appwrite-network
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - "import('http').then(http => http.get('http://localhost:3000', res => process.exit(0)).on('error', () => process.exit(1)))"
      interval: 20s
      timeout: 5s
      retries: 3

  openruntimes-executor:
    container_name: openruntimes-executor
    hostname: appwrite-executor
    stop_signal: SIGINT
    image: 'openruntimes/executor:0.8.6'
    networks:
      - appwrite-network
      - runtimes-network
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - 'appwrite-builds:/storage/builds:rw'
      - 'appwrite-functions:/storage/functions:rw'
      - 'appwrite-sites:/storage/sites:rw'
      - '/tmp:/tmp:rw'
    environment:
      - OPR_EXECUTOR_IMAGE_PULL=disabled
      - 'OPR_EXECUTOR_NETWORK=runtimes-network'
      - 'OPR_EXECUTOR_ENV=production'
      - 'OPR_EXECUTOR_RUNTIMES=node-20.0,php-8.2,python-3.11,ruby-3.2'
      - OPR_EXECUTOR_SECRET=${SERVICE_PASSWORD_64_APPWRITE}
      - OPR_EXECUTOR_RUNTIME_VERSIONS=v5
      - 'OPR_EXECUTOR_STORAGE_DEVICE=local'

  appwrite-mariadb:
    image: 'mariadb:10.11'
    container_name: appwrite-mariadb
    networks:
      - appwrite-network
    volumes:
      - 'appwrite-mariadb:/var/lib/mysql:rw'
    environment:
      - MYSQL_ROOT_PASSWORD=${SERVICE_PASSWORD_MARIADBROOT}
      - MYSQL_DATABASE=appwrite
      - MYSQL_USER=${SERVICE_USER_MARIADB}
      - MYSQL_PASSWORD=${SERVICE_PASSWORD_MARIADB}
      - MARIADB_AUTO_UPGRADE=1
    command: 'mysqld --innodb-flush-method=fsync'
    healthcheck:
      test:
        - CMD
        - healthcheck.sh
        - '--connect'
        - '--innodb_initialized'
      interval: 20s
      timeout: 10s
      retries: 5

  appwrite-redis:
    image: 'redis:7.2.4-alpine'
    container_name: appwrite-redis
    networks:
      - appwrite-network
    command: 'redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --maxmemory-samples 5'
    volumes:
      - 'appwrite-redis:/data:rw'
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      interval: 20s
      timeout: 10s
      retries: 5

  cloudflared:
    image: 'cloudflare/cloudflared:latest'
    container_name: cloudflared
    restart: unless-stopped
    # IMPORTANTE: Agora aponta para o Nginx na porta 443
    command: 'tunnel --no-autoupdate run --url http://nginx:443'
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    networks:
      - appwrite-network
    depends_on:
      - nginx

  # NOVO SERVIÇO: Nginx como proxy reverso
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro  # Coloque seus certificados aqui
    networks:
      - appwrite-network
    depends_on:
      - appwrite
      - appwrite-console

# Redes
networks:
  appwrite-network:
    driver: bridge
  runtimes-network:
    driver: bridge

# Volumes
volumes:
  appwrite-mariadb:
  appwrite-redis:
  appwrite-cache:
  appwrite-uploads:
  appwrite-certificates:
  appwrite-functions:
  appwrite-sites:
  appwrite-builds:
  appwrite-config:
  appwrite-imports: